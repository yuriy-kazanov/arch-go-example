# This file is auto-generated by DevPlatform for further customizing as you wish.
# NOTE: You should not delete this file!

stages:
  - build
  - arch_check
  - test
  - deploy

arch_go_check:
  stage: arch_check
  image: golang:1.22
  script:
    # Устанавливаем arch-go (если нужно)
    - go install github.com/fdaines/arch-go/cmd/arch-go/v2@v2.1.0

    # Запускаем проверку и выводим JSON в файл
    - arch-go --json > arch_report.json

    # Показываем отчёт (для отладки)
    - cat arch_report.json

    # Проверяем compliance.pass с помощью jq
    - apt-get update && apt-get install -y jq
    - |
      PASS=$(jq -r '.compliance.pass' arch_report.json)

      echo "Compliance pass: $PASS"

      if [ "$PASS" != "true" ]; then
        echo "❌ Arch-go compliance check failed!"
        exit 1
      fi

    # Если всё ок
    - echo "✅ Arch-go compliance passed!"

test:
  stage: test
  script:
    - echo 'ok'
